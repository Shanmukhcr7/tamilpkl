<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Star Tamil</title>

  <!-- Shaka Player -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css" crossorigin="anonymous">

  <style>
    :root{
      --bg:#000;
      --card: rgba(255,255,255,0.05);
      --muted:#d1d5db;
      --accent:#3b82f6;
      --highlight:#facc15;
    }
    [data-theme="light"]{
      --bg:#f7f7f8;
      --card: rgba(0,0,0,0.05);
      --muted:#374151;
      --accent:#2563eb;
      --highlight:#b45309;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;width:100%;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .shaka-video-container{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
    video{width:100%;height:100%;background:#000;object-fit:contain;max-height:100vh}
    /* hide default spinner (you used it previously) */
    .shaka-spinner-container,.shaka-spinner,.shaka-spinner-svg{display:none!important;visibility:hidden!important;opacity:0!important}

    /* Viewer count */
    #viewerCount{
      position:fixed;top:16px;left:50%;transform:translateX(-50%);
      background:rgba(0,0,0,0.6);color:#00ff00;padding:8px 14px;border-radius:20px;font-weight:700;z-index:1200;pointer-events:none;
    }

    /* Controls: keep sleek compact look */
    .controls-overlay{
      position:fixed;right:18px;bottom:18px;z-index:1200;display:flex;gap:10px;align-items:center;
    }
    .btn{
      background:var(--card);color:var(--muted);padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);cursor:pointer;
      backdrop-filter: blur(6px);
    }
    .btn:hover{transform:translateY(-2px)}

    /* Modal base */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);backdrop-filter:blur(6px);z-index:2000}
    .modal.hidden{display:none}
    .modal-content{width:90%;max-width:420px;padding:26px;border-radius:16px;background:var(--card);border:1px solid rgba(255,255,255,0.08);color:var(--muted);text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.4)}
    .modal-content h2{color:var(--highlight);margin-bottom:8px}
    .modal-content p{margin-bottom:16px;line-height:1.4}
    .modal-actions{display:flex;gap:10px;flex-direction:column}
    .modal-actions .btn{width:100%}

    /* Chrome modal special look */
    #chromeModal .modal-content{border-color:rgba(248,113,113,0.25);background:rgba(255,0,0,0.04)}
    #chromeModal h2{color:#f87171}

    /* small responsive tweaks */
    @media(min-width:900px){
      .modal-content{padding:30px}
      .modal-actions{flex-direction:row}
      .modal-actions .btn{flex:1}
    }
  </style>
</head>
<body>

  <!-- Viewer count -->
  <div id="viewerCount">Viewers: 0</div>

  <!-- Player container (Shaka UI attaches here) -->
  <div class="shaka-video-container" data-shaka-player-container shaka-controls="true" style="cursor:none">
    <div class="shaka-video-container shaka-video" data-shaka-player>
      <!-- keep your blob src (replace if necessary) -->
      <video id="playerVideo" autoplay playsinline preload="metadata" poster="" src="blob:https://matcheslinks-eaa.pages.dev/0a159ba2-7df0-461b-ac35-8ef3d279407a" class="shaka-video"></video>
    </div>
    <!-- canvas is optional for overlays; keep if Shaka needs it -->
    <canvas class="shaka-canvas-container" aria-hidden="true"></canvas>
  </div>

  

  

  <script>
document.addEventListener('DOMContentLoaded', () => {
  const viewerCountEl = document.getElementById('viewerCount');

  try {
    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    let wsUrl;

    if (window.location.hostname === 'localhost') {
      // Local testing
      wsUrl = `${protocol}://localhost:3000`;
    } else {
      // Deployed environment (same host as page)
      wsUrl = `${protocol}://${window.location.host}`;
    }

    const ws = new WebSocket(wsUrl);

    ws.onopen = () => console.log('✅ WebSocket connected:', wsUrl);
    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data.type === 'viewerCount') {
          viewerCountEl.textContent = `Viewers: ${data.count}`;
        }
      } catch (e) {
        console.error('WS parse error', e);
      }
    };
    ws.onerror = (err) => console.error('❌ WS error', err);
    ws.onclose = () => console.warn('⚠️ WebSocket closed');
  } catch (err) {
    console.warn('WebSocket setup failed:', err);
  }
});
</script>

  <script>
    /**********************************************
     * HDNEA Cookie refresh + Shaka Player setup
     **********************************************/
    (async function(){
      if (!window.shaka) {
        console.error('Shaka library not loaded');
        return;
      }
      shaka.polyfill.installAll();

      if (!shaka.Player.isBrowserSupported()) {
        console.error('Browser not supported by Shaka');
        // optionally show a UI message here
        return;
      }

      const COOKIE_URL = 'https://matcheslinks-eaa.pages.dev/cookie.txt';
      const COOKIE_REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes
      let cookieHeader = '';

      async function fetchAndUpdateCookie(){
        try {
          const response = await fetch(COOKIE_URL + '?t=' + Date.now());
          if (!response.ok) throw new Error('cookie fetch failed: ' + response.status);
          const cookieText = (await response.text()).trim();
          cookieHeader = cookieText;
          console.log('HDNEA fetched');
          return cookieHeader;
        } catch (err) {
          console.warn('HDNEA fetch error, using previous if any', err);
          if (cookieHeader) return cookieHeader;
          throw err;
        }
      }

      // first fetch (best-effort)
      try { await fetchAndUpdateCookie(); } catch(e){console.warn('initial cookie fetch failed', e)}

      // keep refreshing
      setInterval(fetchAndUpdateCookie, COOKIE_REFRESH_INTERVAL);

      // Shaka player init
      const video = document.getElementById('playerVideo');
      const player = new shaka.Player(video);
      const container = document.querySelector('.shaka-video-container');
      const ui = new shaka.ui.Overlay(player, container, video);

      // Configure UI and streaming behavior
      ui.configure({
        controlPanelElements: [
          'play_pause', 'time_and_duration', 'mute', 'volume',
          'spacer', 'language', 'captions', 'picture_in_picture',
          'quality', 'fullscreen'
        ],
        volumeBarColors: { base: 'rgba(63, 187, 1, 1)', level: 'rgb(255, 69, 0)' },
        seekBarColors: { base: 'rgb(41, 41, 163)', buffered: 'rgb(35, 99, 3)', played: 'rgba(63, 187, 1, 1)' }
      });

      // DRM config (keep your keys)
      const drmConfig = {
        clearKeys: {
          "d0d750ebd52b5756aa7fb833f61ceece": "4ae62a20c030c918aad24193c1dda229"
        }
      };

      // Example MPD (yours)
      const streamUrl = "https://jiotvmblive.cdn.jio.com/bpk-tv/Star_Sports_1_Tamil_BTS/output/index.mpd";

      player.configure({
        drm: drmConfig,
        streaming: {
          lowLatencyMode: true,
          bufferingGoal: 15,
          rebufferingGoal: 2,
          bufferBehind: 15,
          retryParameters: { timeout: 10000, maxAttempts: 5, baseDelay: 300, backoffFactor: 1.2 },
          segmentRequestTimeout: 8000,
          segmentPrefetchLimit: 2,
          useNativeHlsOnSafari: true
        },
        manifest: { retryParameters: { timeout: 8000, maxAttempts: 3 } }
      });

      // Inject headers & append cookie param where needed
      player.getNetworkingEngine().registerRequestFilter((type, request) => {
        // set referer & ua & cookie header for each request
        if (typeof cookieHeader === 'string' && cookieHeader.length) {
          request.headers['Cookie'] = cookieHeader;
        }
        request.headers['Referer'] = 'https://www.jiotv.com/';
        request.headers['User-Agent'] = "plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6";

        // Append cookie param to manifest/segment URIs if not present
        if ((type === shaka.net.NetworkingEngine.RequestType.MANIFEST ||
             type === shaka.net.NetworkingEngine.RequestType.SEGMENT) &&
             request.uris && request.uris[0] && !request.uris[0].includes('__hdnea__=')) {
          const separator = request.uris[0].includes('?') ? '&' : '?';
          // cookieHeader should be in query-ready form (e.g. __hdnea__=xxx). If your cookie file already contains the full "key=value" string this will append correctly.
          request.uris[0] = request.uris[0] + separator + cookieHeader;
        }
      });

      try{
        await player.load(streamUrl);
        console.log('Shaka loaded stream');
      } catch(err){
        console.error('Shaka load error', err);
      }

      // expose simple debug toggles
      window.__shakaPlayer = player;

    })();
  </script>

</body>
</html>
